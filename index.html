<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="icon" href="favicon.png"  sizes="16x16">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
          integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <title>Firestore Functionality demo</title>
</head>
<body class="container">
<div class="row mt-3">
    <div class="col-md-12">
        <nav>
            <div class="nav nav-tabs" id="nav-tab" role="tablist">
                <a class="nav-item nav-link active" id="nav-all-users-tab" data-toggle="tab" href="#nav-all-users"
                   role="tab"
                   aria-controls="nav-all-users" aria-selected="true">All Users</a>
                <a class="nav-item nav-link" id="nav-add-user-tab" data-toggle="tab" href="#nav-add-user"
                   role="tab"
                   aria-controls="nav-home" aria-selected="true">Add User</a>
                <a class="nav-item nav-link" id="nav-update-user-tab" data-toggle="tab" href="#nav-update-user"
                   role="tab"
                   aria-controls="nav-home" aria-selected="true">Update User</a>
                <a class="nav-item nav-link" id="nav-delete-user-tab" data-toggle="tab" href="#nav-delete-user"
                   role="tab"
                   aria-controls="nav-home" aria-selected="true">Delete User</a>
            </div>
        </nav>
    </div>
</div>
<div class="row mt-4">
    <div class="col-md-12">
        <div class="tab-content" id="nav-tabContent">
            <div class="tab-pane fade show active" id="nav-all-users" role="tabpanel"
                 aria-labelledby="nav-all-users-tab">
                <div class="row">
                    <div class="col-md-10 bg-light pt-2">
                        <div class="users" style="min-height: 500px; ">
                            <table class="table table-striped">
                                <thead>
                                <tr>
                                    <th scope="col">S.N.</th>
                                    <th scope="col">Full Name</th>
                                    <th scope="col">Phone</th>
                                    <th scope="col">Address</th>
                                </tr>
                                </thead>
                                <tbody class="user-lists">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="nav-add-user" role="tabpanel"
                 aria-labelledby="nav-add-user-tab">
                <div class="row">
                    <div class="col-md-10 bg-light pt-2">
                        <form class="add-user-form" style="min-height: 500px; ">
                            <div class="form-group">
                                <label for="add_full_name">Full Name</label>
                                <input type="text" class="form-control" id="add_full_name" placeholder="Full Name"
                                       name="full_name"
                                       value="">
                            </div>
                            <div class="form-group">
                                <label for="add_phone">Phone</label>
                                <input type="text" class="form-control" id="add_phone" placeholder="Phone" name="phone"
                                       value="">
                            </div>
                            <div class="form-group">
                                <label for="add_address">Address</label>
                                <input type="text" class="form-control" id="add_address" placeholder="Addresss"
                                       name="address"
                                       value="">
                            </div>
                            <div class="form-group">
                                <button type="button" class="btn btn-primary btn-block" id="btn-add-user">Add User
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="nav-update-user" role="tabpanel"
                 aria-labelledby="nav-update-user-tab">
                <div class="row">
                    <div class="col-md-10 bg-light pt-2">
                        <form class="update-user-form" style="min-height: 500px; ">
                            <div class="form-group">
                                <label for="update-user-id">Select User</label>
                                <select class="custom-select user-select-list" id="update-user-id" name="id">
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="update_full_name">Full Name</label>
                                <input type="text" class="form-control" id="update_full_name" placeholder="Full Name"
                                       name="full_name"
                                       value="">
                            </div>
                            <div class="form-group">
                                <label for="update_phone">Phone</label>
                                <input type="text" class="form-control" id="update_phone" placeholder="Phone"
                                       name="phone"
                                       value="">
                            </div>
                            <div class="form-group">
                                <label for="update_address">Address</label>
                                <input type="text" class="form-control" id="update_address" placeholder="Addresss"
                                       name="address"
                                       value="">
                            </div>
                            <div class="form-group">
                                <button type="button" class="btn btn-primary btn-block" id="btn-update-user">Update
                                    User
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="nav-delete-user" role="tabpanel"
                 aria-labelledby="nav-delete-user-tab">
                <div class="row">
                    <div class="col-md-10 bg-light pt-2">
                        <form style="min-height: 500px; ">
                            <div class="form-group">
                                <label for="delete-user-id">Select User</label>
                                <select class="custom-select user-select-list" id="delete-user-id" name="id">
                                </select>
                            </div>
                            <div class="form-group">
                                <button type="button" class="btn btn-primary btn-block" id="btn-delete-user">Delete
                                    User
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js"
        integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s"
        crossorigin="anonymous"></script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.2.10/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.2.10/firebase-firestore.js"></script>
<script>
    $(document).ready(function () {
        let user_container = $('.user-lists');
        var users = [];
        firebase.initializeApp({
            apiKey: "YOUR API KEY",
            authDomain: "YOUR AUTH DOMAIN,
            projectId: "YOUR PROJECT ID",
        });
        $('#btn-delete-user').click(function () {
            delete_user($('#delete-user-id').val());
        });
        $("#btn-add-user").on("click", function (event) {
            event.preventDefault();
            let user_data = $('.add-user-form').serializeArray();
            let request_data = {}
            $.each(user_data, function (key, value) {
                request_data[value.name] = value.value;
            });
            add_user(request_data)
        })

        $('#update-user-id').change(function (event) {
            console.log(event.target.value);
            update_usere_info_on_user_change(event.target.value);
        })

        $("#btn-update-user").on("click", function (event) {
            event.preventDefault();
            let user_data = $('.update-user-form').serializeArray();
            let request_data = {}
            $.each(user_data, function (key, value) {
                request_data[value.name] = value.value;
            });
            update_user(request_data)
        });

        var db = firebase.firestore();
        db.collection("users")
            .onSnapshot((snapshot) => {
                user_container.append('');
                snapshot.docChanges().forEach((change) => {
                    let type = change.type;
                    let data = change.doc.data();
                    let id = change.doc.id;
                    if(type === "added") {
                        users.push({
                            'id': id,
                            'full_name': data.full_name,
                            'phone': data.phone,
                            'address': data.address,
                        })
                    }
                    if(type === "modified") {
                        let index = users.findIndex(x => x.id === id);
                        users[index] = {
                            'id': id,
                            'full_name': data.full_name,
                            'phone': data.phone,
                            'address': data.address,
                        }
                    }
                    if(type === "removed") {
                        let index = users.findIndex(x => x.id === id);
                        users.splice(index, 1);
                    }
                });
                update_user_details();
                update_user_select_list();
            });

        function update_user_details () {
            let table_data = '';
            user_container.text(table_data);
            $.each(users, function (index, user) {
                table_data += `<tr>
                    <td>${index + 1}</td>
                    <td>${user.full_name}</td>
                    <td>${user.phone}</td>
                    <td>${user.address}</td>
                    </tr>`
            });
            user_container.append(table_data);
        }

        function update_user_select_list () {
            let table_data = `<option value=''>Select User</option>`;
            let container = $('.user-select-list');
            container.text(table_data)
            $.each(users, function (index, user) {
                table_data += `<option value=${user.id}>${user.full_name}</option>`
            });
            container.html(table_data)
        }

        function add_user (data) {
            db.collection("users").add(data).then(() => {
                swal({
                    title: "User successfully Added!",
                    icon: "success",
                    button: "Close",
                });
                $('.add-user-form')[0].reset();
            }).catch((error) => {
                swal({
                    title: "Error Adding user",
                    icon: "error",
                    button: "Close",
                });
            });
        }

        function update_user (data) {
            let user_id = data.id;
            if(!user_id) {
                return swal({
                    title: "Please select the user",
                    icon: "error",
                    button: "Close",
                });
            }
            delete data.id;
            db.collection("users").doc(user_id).update(data).then(() => {
                swal({
                    title: "User successfully updated!",
                    icon: "success",
                    button: "Close",
                });
                $('.update-user-form')[0].reset();
            }).catch((error) => {
                swal({
                    title: "Error updating user",
                    icon: "error",
                    button: "Close",
                });
            });
        }

        function delete_user (user_id) {
            if(!user_id) {
                return swal({
                    title: "Please select the user",
                    icon: "error",
                    button: "Close",
                });
            }
            db.collection("users").doc(user_id).delete().then(() => {
                swal({
                    title: "User successfully deleted!",
                    icon: "success",
                    button: "Close",
                });
            }).catch((error) => {
                swal({
                    title: "Error deleting User",
                    icon: "error",
                    button: "Close",
                });
            });
        }

        function update_usere_info_on_user_change (user_id) {
            let user_data = users.find(x => x.id === user_id)
            if(user_data) {
                $('#update_full_name').val(user_data.full_name);
                $('#update_address').val(user_data.address);
                $('#update_phone').val(user_data.phone);
            }
        }
    });
</script>

</body>
</html>
